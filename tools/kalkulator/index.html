<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator – Luderbein</title>
  <meta name="description" content="V1.4 – Schiefer-Kalkulator: auswählen, kalkulieren, dann per WhatsApp oder E-Mail anfragen." />
  <link rel="stylesheet" href="/assets/style.css?v=10" />
  <link rel="stylesheet" href="/assets/nav-dropdown.css?v=1" />

  <style>
    .calcbox{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      padding:16px;
    }
    .calcgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:760px){.calcgrid{grid-template-columns:1fr}}
    label.smalllab{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }
    select,input[type="number"],textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .checkrow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .checkrow input{margin-top:3px}
    .checkrow .muted{font-size:12px;color:var(--muted);margin-top:2px}
    .subcard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:14px;
      margin-top:14px;
    }
    .total{font-size:18px;font-weight:800;letter-spacing:.2px}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,80,80,.25);
      background:rgba(255,80,80,.08);
      color:rgba(255,220,220,.95);
      font-size:13px;
      display:none;
    }
    .oknote{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.85);
      font-size:13px;
      display:none;
    }
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .inline .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.86);
    }
    .radioStack{display:grid;gap:10px}

    /* CTA Split am Ende */
    .ctaSplit{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:760px){.ctaSplit{grid-template-columns:1fr}}
    .ctaCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .ctaCard h4{
      margin:0 0 6px 0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .ctaCard p{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .ctaCard .cta{margin-top:8px}
  </style>
</head>

<body>
<header>
  <div class="wrap nav">
    <a class="brand" href="/">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <strong>Luderbein</strong><br>
        <span>Schwibbögen • Gravur • Sonderwünsche</span>
      </div>
    </a>
    <button class="navbtn" type="button" data-nav-toggle aria-expanded="false" aria-label="Menü öffnen">
      <span class="navicon"><span></span></span>
    </button>
    <nav class="menu" data-nav data-open="0" aria-label="Hauptmenü">
      <a href="/">Start</a>
      <details class="navdrop" data-navdrop>
        <summary class="navdrop__sum" aria-label="Leistungen öffnen">
          Leistungen <span class="navdrop__chev" aria-hidden="true">▾</span>
        </summary>
        <div class="navdrop__panel" role="menu" aria-label="Leistungen">
          <a href="/leistungen/schiefer/" role="menuitem">Schiefer</a>
          <a href="/leistungen/metall/" role="menuitem">Metall</a>
          <a href="/leistungen/holz/" role="menuitem">Holz</a>
          <a href="/leistungen/acryl/" role="menuitem">Acryl</a>
          <a href="/leistungen/custom/" role="menuitem">Custom</a>
          <div class="navdrop__sep" aria-hidden="true"></div>
          <a href="/tools/kalkulator/" role="menuitem">Kalkulator</a>
          <a href="/service/" role="menuitem">Downloads</a>
        </div>
      </details>
      <a href="/ueber/">Über</a>
      <a href="/kontakt/">Kontakt</a>
      <a href="/rechtliches/impressum.html">Impressum</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <span class="badge"><i></i> Tool</span>
    <h1>Kalkulator <small style="font-size:0.65em;opacity:0.7">(V1.4 – Schiefer + Anfrage für Metall/Holz/Acryl)</small></h1>
    <p class="lead">
      Wähle Material + Variante + Format. Danach bekommst du eine fertige Nachricht,
      die du mir 1:1 per WhatsApp oder Mail schicken kannst.
    </p>
    <div class="notice">
      <strong style="color:var(--text)">Hinweis:</strong><br>
      Kein Shop: Du schickst mir die fertige Nachricht – ich bestätige kurz Preis & Machbarkeit, dann geht’s los.
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <h2>Konfiguration</h2>
      <p class="small muted">Schiefer – Preise Stand 01/2026. Metall/Holz/Acryl: Anfrage-Flow.</p>
    </div>

    <div class="calcbox">
      <div class="calcgrid">
        <div>
          <label class="smalllab" for="cat">Oberkategorie</label>
          <select id="cat">
            <option value="schiefer">Schiefer</option>
            <option value="metall">Metall (auf Anfrage)</option>
            <option value="holz">Holz (auf Anfrage)</option>
            <option value="acryl">Acryl (auf Anfrage)</option>
          </select>
        </div>
        <div>
          <label class="smalllab" for="variant">Ausführung</label>
          <select id="variant"></select>
        </div>
        <div>
          <label class="smalllab" for="format">Format</label>
          <select id="format"></select>
        </div>
        <div>
          <label class="smalllab" for="qty">Stückzahl</label>
          <input id="qty" type="number" min="1" max="50" value="1" />
        </div>
      </div>

      <div class="subcard" id="upgradesBox">
        <div class="inline" style="margin-bottom:10px">
          <div class="pill" id="inclPill">inkl. …</div>
          <div class="pill" id="notePill">Hinweis …</div>
        </div>

        <div class="grid">
          <div class="card" style="margin:0">
            <h3 style="margin-top:0">Upgrades</h3>

            <div class="checkrow">
              <input type="checkbox" id="widmung">
              <div><div><strong>Signatur / Widmung</strong> <span class="muted" id="p_widmung"></span></div></div>
            </div>

            <div style="height:10px"></div>

            <div class="radioStack" aria-label="Standfuß Auswahl">
              <div class="checkrow">
                <input type="radio" name="standfuss" id="sf_none" value="none" checked>
                <div><div><strong>Kein Standfuß</strong></div></div>
              </div>
              <div class="checkrow">
                <input type="radio" name="standfuss" id="sf_std" value="std">
                <div><div><strong>3D-Standfuß (schwarz)</strong> <span class="muted" id="p_sf_std"></span></div></div>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="checkrow">
              <input type="checkbox" id="wandhalter">
              <div><div><strong>Wandhalterung</strong> <span class="muted" id="p_wandhalter"></span></div></div>
            </div>

            <div style="height:10px"></div>

            <div class="checkrow">
              <input type="checkbox" id="express">
              <div><div><strong>Express (3 Werktage)</strong> <span class="muted" id="p_express"></span></div></div>
            </div>
          </div>

          <div class="card" style="margin:0">
            <h3 style="margin-top:0">Versand / Abholung</h3>

            <div class="radioStack">
              <div class="checkrow">
                <input type="radio" name="ship" id="ship_pickup" value="pickup" checked>
                <div><div><strong>Abholung / Übergabe</strong></div></div>
              </div>
              <div class="checkrow">
                <input type="radio" name="ship" id="ship_send" value="send">
                <div><div><strong>Versand</strong> <span class="muted" id="p_ship"></span></div></div>
              </div>
            </div>

            <div class="hr" style="margin:14px 0"></div>

            <div class="total" id="total">Gesamt: —</div>
            <div class="warn" id="warn"></div>
            <div class="oknote" id="oknote"></div>

            <div class="section" style="margin-top:14px">
              <label class="smalllab" for="note">Notiz (optional)</label>
              <textarea id="note" placeholder="z. B. Maße, Text, Logo/QR, Materialwunsch, Deadline, besonderer Wunsch…"></textarea>
            </div>

            <!-- Split: Anfrage vs Auftrag -->
            <div class="ctaSplit" aria-label="Nächster Schritt">
              <div class="ctaCard">
                <h4>Option A – Erstmal anfragen</h4>
                <p>
                  Du bist noch unsicher? Schick mir kurz die Daten – ich sag dir, was sinnvoll ist (und ob’s machbar ist).
                </p>
                <div class="cta">
                  <a class="btn" id="contactLink" href="/kontakt/">Zur Anfrage (Kontakt)</a>
                </div>
              </div>

              <div class="ctaCard">
                <h4>Option B – Nachricht raushauen</h4>
                <p>
                  Für Schiefer: Preis fixieren. Für Metall/Holz/Acryl: Anfrage-Nachricht (ohne Preis).
                </p>
                <div class="cta">
                  <a class="btn primary" id="waLink" href="#" rel="noopener">WhatsApp</a>
                  <a class="btn" id="mailLink" href="#">E-Mail</a>
                </div>
              </div>
            </div>

            <div class="oknote" id="fallbackNote"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="wrap foot">
    <div class="small">© <span id="y"></span> Luderbein</div>
    <div class="small">
      <a href="/rechtliches/impressum.html">Impressum</a> ·
      <a href="/rechtliches/datenschutz.html">Datenschutz</a>
    </div>
  </div>
</footer>

<script src="/assets/site.js?v=10"></script>
<script src="/assets/nav-dropdown.js?v=1"></script>
<script src="/assets/pricing.js?v=1.4.0"></script>

<script>
  document.getElementById('y').textContent = new Date().getFullYear();
  console.log("pricing.js loaded:", window.LUDERBEIN_PRICING?.meta);
</script>

<script>
(function(){
  const P = window.LUDERBEIN_PRICING;
  if(!P || !P.products){
    console.warn("Pricing data missing");
    return;
  }

  const $cat=document.getElementById('cat'),
        $variant=document.getElementById('variant'),
        $format=document.getElementById('format'),
        $qty=document.getElementById('qty'),
        $widmung=document.getElementById('widmung'),
        $wandhalter=document.getElementById('wandhalter'),
        $express=document.getElementById('express'),
        $sfNone=document.getElementById('sf_none'),
        $sfStd=document.getElementById('sf_std'),
        $shipPickup=document.getElementById('ship_pickup'),
        $shipSend=document.getElementById('ship_send'),
        $total=document.getElementById('total'),
        $warn=document.getElementById('warn'),
        $oknote=document.getElementById('oknote'),
        $wa=document.getElementById('waLink'),
        $mail=document.getElementById('mailLink'),
        $contact=document.getElementById('contactLink'),
        $note=document.getElementById('note'),
        $inclPill=document.getElementById('inclPill'),
        $notePill=document.getElementById('notePill'),
        $upgradesBox=document.getElementById('upgradesBox'),
        $fallbackNote=document.getElementById('fallbackNote');

  // WhatsApp bekommt beim Klick IMMER die zuletzt gebaute URL
  let lastWaUrl = "";

  function euro(n){
    return (Math.round(n*100)/100).toFixed(2).replace('.',',')+' €';
  }
  function getSchiefer(){
    return P.products.schiefer;
  }
  function isSchiefer(){
    return ($cat.value === 'schiefer');
  }

  function buildContactUrlFromSelection(sel){
    try{
      const qs = new URLSearchParams();
      if(sel?.S?.label) qs.set('p', sel.S.label);
      if(sel?.V?.label) qs.set('v', sel.V.label);
      if(sel?.F?.label) qs.set('f', sel.F.label);
      if(sel?.qty) qs.set('qty', String(sel.qty));
      const n = ($note?.value || '').trim();
      if(n) qs.set('note', n);
      const q = qs.toString();
      return '/kontakt/' + (q ? ('?' + q) : '');
    }catch(e){
      return '/kontakt/';
    }
  }

  function buildInquiryMessage(catKey){
    const prod = P.products?.[catKey];
    const pLabel = prod?.label || catKey;

    const qty = Math.max(1, parseInt($qty.value || '1', 10));
    const n = ($note?.value || '').trim();

    const lines = [
      "Hi Luderbein, ich möchte anfragen:",
      `- Kategorie: ${pLabel}`,
      `- Stückzahl: ${qty}`
    ];

    if(n) lines.push(`- Notiz: ${n}`);
    lines.push("Foto/Skizze/Maße schicke ich gleich mit.");

    return { pLabel, msg: lines.join('\n') };
  }

  function setFallbackLinks(catKey){
    const { pLabel, msg } = buildInquiryMessage(catKey);

    // Kontakt-Link mit Parametern
    const qs = new URLSearchParams();
    qs.set('p', pLabel);
    const contactUrl = '/kontakt/?' + qs.toString();
    if($contact) $contact.href = contactUrl;

    // WhatsApp + Mail (Anfrage, ohne Preis)
    lastWaUrl = 'https://wa.me/491725925858?text=' + encodeURIComponent(msg);
    if($wa) $wa.href = lastWaUrl;

    const subj = `Anfrage ${pLabel}`;
    if($mail) $mail.href = 'mailto:luderbein_gravur@icloud.com?subject='
      + encodeURIComponent(subj)
      + '&body='
      + encodeURIComponent(msg + '\n\nDanke!');

    if($fallbackNote){
      $fallbackNote.style.display = 'block';
      $fallbackNote.textContent = `Für ${pLabel} läuft aktuell alles über Anfrage (ohne Preis im Kalkulator).`;
    }
  }

  function clearFallbackNote(){
    if($fallbackNote){
      $fallbackNote.style.display = 'none';
      $fallbackNote.textContent = '';
    }
  }

  function fillVariant(){
    const cat=$cat.value;
    $variant.innerHTML='';
    $format.innerHTML='';

    // Nur Schiefer ist aktiv kalkulierbar
    if(!P.products[cat] || cat !== 'schiefer'){
      const opt=document.createElement('option');
      opt.value="";
      opt.textContent="Nur auf Anfrage";
      $variant.appendChild(opt);

      const opt2=document.createElement('option');
      opt2.value="";
      opt2.textContent="—";
      $format.appendChild(opt2);

      $variant.disabled=true;
      $format.disabled=true;

      if($upgradesBox) $upgradesBox.style.opacity = ".55";

      // Anfrage-Links setzen
      setFallbackLinks(cat);

      // UI-Hinweis
      $total.textContent='Gesamt: —';
      $warn.style.display='none';
      $oknote.style.display='block';

      const note = P.products?.[cat]?.note || 'Diese Kategorie ist noch nicht im Kalkulator aktiv. Bitte anfragen.';
      $oknote.textContent = note;

      return;
    }

    // Schiefer aktiv
    clearFallbackNote();
    if($upgradesBox) $upgradesBox.style.opacity = "1";
    $variant.disabled=false;
    $format.disabled=false;

    const S=getSchiefer();
    const keys = Object.keys(S.variants);

    keys.forEach((k)=>{
      const v=S.variants[k];
      const opt=document.createElement('option');
      opt.value=k;
      opt.textContent=v.label;
      $variant.appendChild(opt);
    });

    if(keys.length){
      $variant.value = keys[0];
    }
  }

  function fillFormat(){
    if(!isSchiefer()) return;

    const S=getSchiefer();
    const vKey=$variant.value;
    const V=S.variants[vKey];

    $format.innerHTML='';

    if(!V || !Array.isArray(V.formats) || !V.formats.length){
      const opt=document.createElement('option');
      opt.value="";
      opt.textContent="—";
      $format.appendChild(opt);
      return;
    }

    V.formats.forEach((f)=>{
      const opt=document.createElement('option');
      opt.value=f.id;
      opt.textContent=f.label+' – '+euro(f.price);
      $format.appendChild(opt);
    });

    $inclPill.textContent = S.includes || 'inkl. …';
    $notePill.textContent = V.note || P.meta.note || "";
  }

  function getSelected(){
    if(!isSchiefer()) return null;

    const S=getSchiefer();
    const V=S.variants[$variant.value];
    const F=V?.formats?.find(x=>x.id===$format.value);
    const qty=Math.max(1,parseInt($qty.value||'1',10));

    const U=S.upgrades;
    const ups=[];
    if($widmung.checked) ups.push(U.widmung);
    if($sfStd.checked) ups.push(U.standfuss_std);
    if($wandhalter.checked) ups.push(U.wandhalter);
    if($express.checked) ups.push(U.express);

    const wantsShip=$shipSend.checked;

    return {S,V,F,qty,ups,wantsShip};
  }

  function bindPrices(){
    const S=getSchiefer();
    const U=S.upgrades;

    const set = (id, txt) => {
      const el = document.getElementById(id);
      if(el) el.textContent = txt;
    };

    set('p_widmung', '('+euro(U.widmung.price)+')');
    set('p_sf_std', '('+euro(U.standfuss_std.price)+')');
    set('p_wandhalter', '('+euro(U.wandhalter.price)+')');
    set('p_express', '('+euro(U.express.price)+')');

    if(P.shipping?.enabled){
      set('p_ship', '('+euro(P.shipping.basePrice)+')');
    } else {
      set('p_ship', '(deaktiviert)');
      $shipSend.disabled = true;
      $shipPickup.checked = true;
    }
  }

  function calc(){
    // ✅ Anfrage-Modus für Metall/Holz/Acryl (ohne Preise)
    if(!isSchiefer()){
      setFallbackLinks($cat.value);
      $total.textContent='Gesamt: —';
      $warn.style.display='none';
      $oknote.style.display='block';
      $oknote.textContent = P.products?.[$cat.value]?.note || 'Bitte anfragen.';
      return;
    }

    const sel=getSelected();

    if($contact){
      $contact.href = buildContactUrlFromSelection(sel);
    }

    if(!sel || !sel.F){
      $total.textContent='Gesamt: —';
      lastWaUrl = "";
      return;
    }

    const {S,V,F,qty,ups,wantsShip}=sel;

    const base=F.price*qty;
    const up=(ups.reduce((a,u)=>a+(u.price||0),0))*qty;

    let subtotal=base+up;
    let ship=0;
    let warn='';
    let ok='';

    if(wantsShip && P.shipping?.enabled){
      const min=P.shipping.minOrderForShipping;
      const free=P.shipping.freeShippingFrom;

      if(subtotal>=free){
        ok=`Versandkostenfrei ab ${euro(free)} erreicht.`;
      } else {
        ship=P.shipping.basePrice;
        ok=`Versand: ${euro(ship)}`;
      }

      if(subtotal<min){
        warn=`Mindestbestellwert für Versand: ${euro(min)}.`;
      }
    }

    const total=subtotal+ship;

    $total.textContent='Gesamt: '+euro(total);
    $warn.style.display=warn?'block':'none';
    $warn.textContent=warn;

    $oknote.style.display=ok?'block':'none';
    $oknote.textContent=ok;

    const upgradesTxt = ups.length
      ? ups.map(u=>`${u.label} (${euro(u.price)})`).join(', ')
      : 'keine';

    const lines=[
      "Hi Luderbein, ich möchte Preis fixieren & den Auftrag starten:",
      `- Material: ${S.label}`,
      `- Ausführung: ${V.label}`,
      `- Format: ${F.label}`,
      `- Stückzahl: ${qty}`,
      `- Upgrades: ${upgradesTxt}`,
      `- Versand: ${wantsShip?'ja':'nein'}`,
      `- Gesamt: ${euro(total)}`
    ];

    if(($note.value || '').trim()){
      lines.push(`- Notiz: ${($note.value || '').trim()}`);
    }

    lines.push("Foto/Infos schicke ich gleich mit.");
    const msg = lines.join('\n');

    lastWaUrl = 'https://wa.me/491725925858?text=' + encodeURIComponent(msg);
    $wa.href = lastWaUrl;

    const subj = `Auftrag ${S.label} – ${V.label}`;
    $mail.href = 'mailto:luderbein_gravur@icloud.com?subject='
      + encodeURIComponent(subj)
      + '&body='
      + encodeURIComponent(msg + '\n\nDanke!');
  }

  function wire(){
    $cat.addEventListener('change', ()=>{
      fillVariant();
      fillFormat();
      if(isSchiefer()){
        bindPrices();
        $oknote.style.display='none';
        $warn.style.display='none';
      }
      calc();
    });

    $variant.addEventListener('change', ()=>{
      fillFormat();
      calc();
    });

    $format.addEventListener('change', calc);
    $qty.addEventListener('input', calc);

    $widmung.addEventListener('change', calc);
    $wandhalter.addEventListener('change', calc);
    $express.addEventListener('change', calc);

    $sfNone.addEventListener('change', calc);
    $sfStd.addEventListener('change', calc);

    $shipPickup.addEventListener('change', calc);
    $shipSend.addEventListener('change', calc);

    $note.addEventListener('input', calc);

    // WhatsApp beim Klick erzwingen
    if($wa){
      $wa.addEventListener('click', (e)=>{
        if(!lastWaUrl) return;
        e.preventDefault();
        window.location.href = lastWaUrl;
      });
    }
  }

  // INIT
  fillVariant();
  fillFormat();

  if(isSchiefer()){
    bindPrices();
    $oknote.style.display='none';
    $warn.style.display='none';
  }

  wire();
  calc();
})();
</script>

</body>
</html>
