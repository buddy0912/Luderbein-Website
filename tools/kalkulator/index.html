<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator – Luderbein</title>
  <meta name="description" content="Kalkulator von Luderbein: Schiefer & Metall kalkulieren, Staffelpreise, Upgrades, Versand, Anfrage per WhatsApp oder E-Mail." />

  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/nav-dropdown.css" />

  <style>
    /* =========================================================
       KALKULATOR – UI (isoliert)
       ========================================================= */
    .cfg {
      margin-top: 14px;
      border: 1px solid rgba(64,62,65,.55);
      background: rgba(26,26,31,.62);
      border-radius: 18px;
      padding: 14px;
    }
    .cfg h2 { margin: 0 0 6px; font-size: 1.05rem; }
    .cfg .hint { color: var(--muted); font-size: .92rem; margin: 0 0 12px; }

    .cfg .step { margin-top: 12px; }
    .cfg .steptitle {
      font-weight: 800;
      letter-spacing: .02em;
      margin: 0 0 8px;
    }

    .cfg .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .cfg .chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(64,62,65,.65);
      background: rgba(42,45,51,.22);
      color: var(--text);
      border-radius: 999px;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .cfg .chip input { display: none; }
    .cfg .chip b { font-weight: 800; }
    .cfg .chip.is-on {
      border-color: rgba(219,16,33,.62);
      background: linear-gradient(180deg, rgba(219,16,33,.18), rgba(70,18,22,.14));
      box-shadow: 0 14px 34px rgba(219,16,33,.10);
    }

    .cfg .fields {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .cfg label {
      display: block;
      font-size: .9rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .cfg select,
    .cfg input[type="text"],
    .cfg input[type="number"],
    .cfg textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(64,62,65,.65);
      background: rgba(14,6,11,.35);
      color: var(--text);
      padding: 12px 12px;
      outline: none;
    }
    .cfg textarea { min-height: 84px; resize: vertical; }

    /* Placeholder dezenter (damit Demo-Text nicht wie echter Text wirkt) */
    .cfg input::placeholder,
    .cfg textarea::placeholder {
      color: rgba(154,146,142,.70);
      opacity: 1;
    }

    .cfg .inline {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .cfg .upgrades {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }
    .cfg .up {
      border: 1px solid rgba(64,62,65,.55);
      background: rgba(42,45,51,.16);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .cfg .up .left {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      min-width: 0;
    }
    .cfg .up input { margin-top: 3px; }
    .cfg .up b { font-weight: 800; display:block; }
    .cfg .up .desc { color: var(--muted); font-size: .92rem; margin-top: 2px; }
    .cfg .up .price { white-space: nowrap; color: var(--text); font-weight: 800; }
    .cfg .up.is-locked { opacity: .85; }
    .cfg .up.is-locked input { pointer-events: none; }

    .cfg .summary {
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(64,62,65,.55);
      background: rgba(42,45,51,.20);
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.45;
    }
    .cfg .summary strong { color: var(--text); }

    .cfg .cta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .cfg .cta .btn { flex: 1 1 180px; }

    .cfg a[data-disabled="1"] {
      opacity: .55;
      pointer-events: none;
      filter: grayscale(.4);
    }

    .cfg .warn {
      margin-top: 10px;
      border: 1px solid rgba(219,16,33,.35);
      background: rgba(219,16,33,.10);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(210,207,206,.92);
    }

    @media (min-width: 760px) {
      .cfg .fields { grid-template-columns: 1fr 1fr; }
      .cfg .fields .full { grid-column: 1 / -1; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap nav">
    <a class="brand" href="/">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <strong>Luderbein</strong><br />
        <span>Schwibbögen • Gravur • Sonderwünsche</span>
      </div>
    </a>

    <button
      class="navbtn"
      type="button"
      data-nav-toggle
      aria-expanded="false"
      aria-controls="nav-main"
      aria-label="Menü öffnen"
    >
      <span class="navicon"><span></span></span>
    </button>

    <nav class="menu" id="nav-main" data-nav aria-label="Hauptmenü" data-open="0">
      <a href="/">Start</a>

      <div class="navdrop" data-navdrop>
        <button
          class="navdrop__sum"
          id="navdrop-leistungen-btn"
          type="button"
          aria-haspopup="true"
          aria-expanded="false"
          aria-controls="navdrop-leistungen-panel"
        >
          Leistungen <span class="navdrop__chev" aria-hidden="true">▾</span>
        </button>

        <div
          class="navdrop__panel"
          id="navdrop-leistungen-panel"
          role="menu"
          aria-labelledby="navdrop-leistungen-btn"
        >
          <a href="/leistungen/schiefer/" role="menuitem">Schiefer</a>
          <a href="/leistungen/metall/" role="menuitem">Metall</a>
          <a href="/leistungen/holz/" role="menuitem">Holz</a>
          <a href="/leistungen/acryl/" role="menuitem">Acryl</a>
          <a href="/leistungen/custom/" role="menuitem">Custom</a>
          <div class="navdrop__sep" aria-hidden="true"></div>
          <a href="/tools/kalkulator/" role="menuitem" aria-current="page">Kalkulator</a>
          <a href="/service/" role="menuitem">Downloads</a>
        </div>
      </div>

      <a href="/ueber/">Über</a>
      <a href="/kontakt/">Kontakt</a>
      <a href="/rechtliches/impressum.html">Impressum</a>
    </nav>
  </div>
</header>

<main class="wrap" id="content">
  <section class="hero">
    <span class="badge"><i></i> Kalkulator</span>
    <h1>Preis grob kalkulieren. Dann sauber anfragen.</h1>
    <p class="lead">
      Schiefer &amp; Metall: Auswahl bauen → Preis/Staffel sehen → per WhatsApp oder E-Mail abschicken.
      <span class="small muted">Kleinunternehmer gem. §19 UStG – keine MwSt. ausgewiesen.</span>
    </p>

    <div class="cfg" data-kalk>
      <h2>Konfigurator</h2>
      <p class="hint">1) Material → 2) Ausführung → 3) Details/Upgrades → 4) Stückzahl/Versand → abschicken.</p>

      <div class="step" aria-label="Schritt 1 – Material">
        <p class="steptitle">Schritt 1 – Material</p>
        <div class="chips" role="radiogroup" aria-label="Material auswählen" data-k-mat></div>
      </div>

      <div class="step" data-k-steps hidden aria-label="Schritt 2 bis 5">
        <p class="steptitle">Schritt 2 – Ausführung</p>
        <div class="fields">
          <div>
            <label for="kVariant">Ausführung</label>
            <select id="kVariant" data-k-variant>
              <option value="">— auswählen —</option>
            </select>
          </div>

          <div>
            <label for="kFormat">Format</label>
            <select id="kFormat" data-k-format>
              <option value="">— auswählen —</option>
            </select>
          </div>
        </div>

        <!-- Metall-spezifisch -->
        <div class="step" data-k-metall-block hidden aria-label="Metall-Optionen">
          <p class="steptitle">Metall – Optionen</p>
          <div class="fields">
            <div>
              <label for="kColor">Farbe</label>
              <select id="kColor" data-k-color>
                <option value="">— auswählen —</option>
              </select>
            </div>

            <div>
              <label for="kEngraving">Gravur</label>
              <select id="kEngraving" data-k-engraving>
                <option value="">— auswählen —</option>
              </select>
            </div>

            <div class="full">
              <label for="kMotif">Motiv</label>
              <select id="kMotif" data-k-motif>
                <option value="">— auswählen —</option>
              </select>
            </div>
          </div>

          <div class="warn" data-k-metall-rules>
            <strong>Regeln:</strong><br>
            Mindestmenge 10 · 1 Motiv pro Auftrag · fertiges Logo (SVG/PDF/PNG/JPG) 1-farbig
          </div>
        </div>

        <p class="steptitle" style="margin-top:14px;">Schritt 3 – Stückzahl &amp; Versand</p>
        <div class="fields">
          <div>
            <label for="kQty">Stückzahl</label>
            <input id="kQty" data-k-qty type="number" min="1" step="1" placeholder="z. B. 25" inputmode="numeric" />
          </div>

          <div>
            <label>Versand</label>
            <div class="chips" role="radiogroup" aria-label="Versand auswählen" data-k-shipmode>
              <label class="chip" data-k-ship-chip>
                <input type="radio" name="k-shipmode" value="pickup">
                <span><b>Abholung</b></span>
              </label>
              <label class="chip is-on" data-k-ship-chip>
                <input type="radio" name="k-shipmode" value="dhl" checked>
                <span><b>Versand</b> (DHL)</span>
              </label>
            </div>
            <span class="small muted" data-k-ship-hint></span>
          </div>

          <div class="full">
            <label for="kNote">Notizen (optional)</label>
            <textarea id="kNote" data-k-note placeholder="Motiv/Deadline/Wunschstil/Verwendung (Outdoor?) …"></textarea>
          </div>
        </div>

        <div class="step" aria-label="Schritt 4 – Upgrades">
          <p class="steptitle">Schritt 4 – Upgrades</p>
          <div class="upgrades" data-k-upgrades></div>
        </div>

        <div class="summary" aria-live="polite">
          <strong>Zusammenfassung:</strong><br>
          <span data-k-summary>Bitte Material &amp; Ausführung wählen.</span>
        </div>

        <div class="cta">
          <a class="btn primary" data-k-wa data-disabled="1" href="#" rel="noopener">WhatsApp</a>
          <a class="btn" data-k-mail data-disabled="1" href="#">E-Mail</a>
        </div>

        <p class="small muted" style="margin-top:10px;">
          Wenn „Auf Anfrage“ erscheint: Menge/Deadline/Motiv kurz dazuschreiben – ich antworte schnell.
        </p>
      </div>
    </div>
  </section>

  <div class="hr"></div>

  <section class="section" aria-label="Hinweise">
    <div class="section-head">
      <h2>Hinweise</h2>
      <p class="small muted">Kalkulator = Richtwert + saubere Anfrage. Final klären wir Motiv/Dateien/Deadline.</p>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Dateien</h3>
        <p>Logos ideal als SVG/PDF/AI. Raster (PNG/JPG) nur 1-farbig &amp; sauber.</p>
      </div>
      <div class="card">
        <h3>Serien</h3>
        <p>Staffelpreise greifen automatisch. Variable Datenliste ist extra (Setup + Stück).</p>
      </div>
      <div class="card">
        <h3>Versand</h3>
        <p>DHL ab 6,95 € · versandkostenfrei ab 80 € (Mindestwert siehst du in der Zusammenfassung).</p>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="wrap foot">
    <div class="small">© <span id="y"></span> Luderbein</div>

    <div class="small">
      <div style="margin-bottom:8px;">Kontakt</div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <a class="btn primary" href="https://wa.me/491725925858" rel="noopener">
          <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px; margin-right:8px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 3C7.03 3 3 6.7 3 11.25c0 2.15.9 4.1 2.39 5.57L4 21l4.46-1.3c1.08.36 2.27.55 3.54.55 4.97 0 9-3.7 9-8.25S16.97 3 12 3Z"
                stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M8.3 11.4h.01M12 11.4h.01M15.7 11.4h.01"
                stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
            </svg>
          </span>
          WhatsApp
        </a>

        <a class="btn" href="mailto:luderbein_gravur@icloud.com">
          <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px; margin-right:8px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4.5 7.5h15v9h-15v-9Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M5.2 8.2 12 13.2l6.8-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          E-Mail
        </a>

        <a class="btn" href="https://instagram.com/Luderbein_Gravur" rel="me noopener">
          <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px; margin-right:8px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 4.5h8A3.5 3.5 0 0 1 19.5 8v8A3.5 3.5 0 0 1 16 19.5H8A3.5 3.5 0 0 1 4.5 16V8A3.5 3.5 0 0 1 8 4.5Z"
                stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M12 10a2.75 2.75 0 1 0 0 5.5A2.75 2.75 0 0 0 12 10Z"
                stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
              <path d="M16.6 7.6h.01" stroke="currentColor" stroke-width="2.4" stroke-linecap="round"/>
            </svg>
          </span>
          Instagram
        </a>

        <a class="btn" href="/kontakt/">
          <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px; margin-right:8px;">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 21a9 9 0 1 0 0-18 9 9 0 0 0 0 18Z" stroke="currentColor" stroke-width="1.8"/>
              <path d="M12 10.8v5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M12 8.2h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
            </svg>
          </span>
          Kontaktseite
        </a>
      </div>
    </div>

    <div class="small">
      <a href="/rechtliches/impressum.html">Impressum</a> ·
      <a href="/rechtliches/datenschutz.html">Datenschutz</a>
    </div>
  </div>
</footer>

<script src="/assets/nav-dropdown.js"></script>
<script src="/assets/site.js"></script>
<script src="/assets/pricing.js"></script>

<script>
  (function () {
    const y = document.getElementById("y");
    if (y) y.textContent = new Date().getFullYear();

    const PR = window.LUDERBEIN_PRICING;
    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const $root = el("[data-kalk]");
    if (!$root || !PR || !PR.products) return;

    const $matWrap = el("[data-k-mat]", $root);
    const $steps = el("[data-k-steps]", $root);

    const $variant = el("[data-k-variant]", $root);
    const $format  = el("[data-k-format]", $root);

    const $metallBlock = el("[data-k-metall-block]", $root);
    const $color   = el("[data-k-color]", $root);
    const $engr    = el("[data-k-engraving]", $root);
    const $motif   = el("[data-k-motif]", $root);

    const $qty     = el("[data-k-qty]", $root);

    // Versand (2 Buttons)
    const $shipWrap = el("[data-k-shipmode]", $root);
    const $shipHint = el("[data-k-ship-hint]", $root);

    const $note    = el("[data-k-note]", $root);
    const $upWrap  = el("[data-k-upgrades]", $root);
    const $sum     = el("[data-k-summary]", $root);

    const $wa      = el("[data-k-wa]", $root);
    const $mail    = el("[data-k-mail]", $root);

    const phoneWA = "491725925858";
    const mailTo  = "luderbein_gravur@icloud.com";

    const eur = (n) => new Intl.NumberFormat("de-DE", { style: "currency", currency: "EUR" }).format(n);
    const clean = (s) => (s || "").toString().trim();

    function setDisabled(a, on) {
      a.dataset.disabled = on ? "1" : "0";
      if (on) a.setAttribute("aria-disabled", "true");
      else a.removeAttribute("aria-disabled");
    }

    function tierUnit(tiers, qty) {
      if (!Array.isArray(tiers)) return { unit: null, note: "Auf Anfrage" };
      for (const t of tiers) {
        const minOk = qty >= (t.min ?? 0);
        const maxOk = (t.max == null) ? true : qty <= t.max;
        if (minOk && maxOk) return { unit: (t.unit ?? t.price ?? null), note: t.note || "" };
      }
      return { unit: null, note: "Auf Anfrage" };
    }

    function getShipMode() {
      const r = el('input[name="k-shipmode"]:checked', $root);
      return r ? r.value : "dhl";
    }

    function setShipModeUI(mode) {
      if (!$shipWrap) return;
      const chips = els("[data-k-ship-chip]", $shipWrap);
      chips.forEach((lab) => {
        const inp = el("input", lab);
        const isOn = inp && inp.value === mode;
        lab.classList.toggle("is-on", !!isOn);
        if (isOn && inp) inp.checked = true;
      });
    }

    function shippingFor(subtotal, shipMode) {
      const S = PR.shipping || { enabled:false };

      // Abholung immer ok
      if (!S.enabled || shipMode !== "dhl") {
        return { ok:true, price:0, note:"Abholung/Übergabe" };
      }

      // DHL: Regeln
      if (subtotal >= (S.freeShippingFrom ?? Infinity)) {
        return { ok:true, price:0, note:`Versand frei ab ${eur(S.freeShippingFrom)}` };
      }

      if (subtotal < (S.minOrderForShipping ?? 0)) {
        return { ok:false, price:null, note:`Versand erst ab ${eur(S.minOrderForShipping)} (sonst bitte anfragen)` };
      }

      return { ok:true, price:(S.basePrice ?? 0), note:`Versand (DHL) ${eur(S.basePrice ?? 0)}` };
    }

    function resetSelect($s, placeholder="— auswählen —") {
      $s.innerHTML = "";
      const o = document.createElement("option");
      o.value = "";
      o.textContent = placeholder;
      $s.appendChild(o);
    }

    function buildMaterialChips() {
      $matWrap.innerHTML = "";
      const activeKeys = Object.keys(PR.products).filter((k) => PR.products[k] && PR.products[k].active);

      activeKeys.forEach((key) => {
        const prod = PR.products[key];

        const lab = document.createElement("label");
        lab.className = "chip";
        lab.innerHTML = `<input type="radio" name="k-mat" value="${key}"><span><b>${prod.label || key}</b></span>`;
        $matWrap.appendChild(lab);

        lab.addEventListener("click", () => {
          els(".chip", $matWrap).forEach((x) => x.classList.remove("is-on"));
          lab.classList.add("is-on");
          lab.querySelector("input").checked = true;

          onMaterial(key);
        });
      });

      if (!activeKeys.length) {
        $matWrap.innerHTML = `<div class="small muted">Keine aktiven Materialien in pricing.js.</div>`;
      }
    }

    let state = {
      matKey: "",
      variantKey: "",
      formatId: "",
      qty: 0,
      shipMode: "dhl",

      // metall extras
      color: "",
      engraving: "",
      motif: "",

      upgrades: new Set()
    };

    function onMaterial(matKey) {
      state.matKey = matKey;
      state.variantKey = "";
      state.formatId = "";
      state.upgrades = new Set();

      resetSelect($variant);
      resetSelect($format);

      $metallBlock.hidden = true;
      resetSelect($color);
      resetSelect($engr);
      resetSelect($motif);

      const prod = PR.products[matKey];
      if (prod && matKey === "metall") $qty.value = 10;
      else if (!$qty.value) $qty.value = 1;

      $steps.hidden = false;

      const variants = (prod && prod.variants) ? prod.variants : {};
      Object.keys(variants).forEach((vKey) => {
        const v = variants[vKey];
        const opt = document.createElement("option");
        opt.value = vKey;
        opt.textContent = v.label || v.title || vKey;
        $variant.appendChild(opt);
      });

      renderUpgrades();
      recalc();
    }

    function onVariant() {
      state.variantKey = $variant.value || "";
      state.formatId = "";
      state.upgrades = new Set();

      resetSelect($format);

      const prod = PR.products[state.matKey];
      const v = prod && prod.variants ? prod.variants[state.variantKey] : null;

      if (v && Array.isArray(v.formats)) {
        v.formats.forEach((f) => {
          const opt = document.createElement("option");
          opt.value = f.id;
          opt.textContent = f.label || f.id;
          $format.appendChild(opt);
        });
      }

      const isMetallBottle = (state.matKey === "metall" && state.variantKey === "flaschenoeffner");

      if (isMetallBottle && v && v.options) {
        $metallBlock.hidden = false;

        resetSelect($color);
        (v.options.colors || []).forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          opt.textContent = c.label;
          $color.appendChild(opt);
        });

        resetSelect($engr);
        (v.options.engraving || []).forEach((e) => {
          const opt = document.createElement("option");
          opt.value = e.id;
          opt.textContent = e.label;
          $engr.appendChild(opt);
        });

        resetSelect($motif);
        (v.options.motif || []).forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.label;
          $motif.appendChild(opt);
        });

        if (v.minQty && Number($qty.value || 0) < v.minQty) $qty.value = v.minQty;
      } else {
        $metallBlock.hidden = true;
      }

      renderUpgrades();
      recalc();
    }

    function onFormat() {
      state.formatId = $format.value || "";
      recalc();
    }

    function renderUpgrades() {
      $upWrap.innerHTML = "";

      const prod = PR.products[state.matKey];
      const v = prod && prod.variants ? prod.variants[state.variantKey] : null;

      if (state.matKey === "schiefer" && prod && prod.upgrades) {
        Object.keys(prod.upgrades).forEach((uKey) => {
          const u = prod.upgrades[uKey];
          const row = document.createElement("label");
          row.className = "up";
          row.innerHTML = `
            <div class="left">
              <input type="checkbox" data-up="${uKey}">
              <div><b>${u.label}</b></div>
            </div>
            <div class="price">${eur(u.price)}</div>
          `;
          $upWrap.appendChild(row);

          row.querySelector("input").addEventListener("change", (e) => {
            if (e.target.checked) state.upgrades.add(uKey);
            else state.upgrades.delete(uKey);
            recalc();
          });
        });
        return;
      }

      if (state.matKey === "metall" && v && v.upgrades) {
        const ups = v.upgrades;
        const order = [
          "engrave_inside_and_outside",
          "variable_data_list",
          "clear_coat",
          "logo_rework",
          "display_stand_3d_printed"
        ].filter((k) => ups[k]);

        order.forEach((uKey) => {
          const u = ups[uKey];

          const row = document.createElement("label");
          row.className = "up";
          row.dataset.upRow = uKey;

          const priceText =
            (u.type === "per_unit") ? `${eur(u.unit)} / Stk` :
            (u.type === "one_time") ? `${eur(u.once)} einmalig` :
            (u.type === "per_unit_tiered") ? `Staffel / Stk` :
            (u.type === "setup_plus_per_unit_tiered") ? `${eur(u.setupFee || 0)} Setup + Staffel / Stk` :
            `—`;

          row.innerHTML = `
            <div class="left">
              <input type="checkbox" data-up="${uKey}">
              <div>
                <b>${u.label}</b>
                <div class="desc">${u.description || ""}</div>
              </div>
            </div>
            <div class="price">${priceText}</div>
          `;
          $upWrap.appendChild(row);

          const input = row.querySelector("input");
          input.addEventListener("change", (e) => {
            if (e.target.checked) state.upgrades.add(uKey);
            else state.upgrades.delete(uKey);
            recalc();
          });
        });
        return;
      }

      $upWrap.innerHTML = `<div class="small muted">Keine Upgrades für diese Auswahl.</div>`;
    }

    function lockBeidseitigUpgrade(shouldLockOn) {
      const row = el(`[data-up-row="engrave_inside_and_outside"]`, $upWrap);
      if (!row) return;
      const cb = el(`input[data-up="engrave_inside_and_outside"]`, row);
      if (!cb) return;

      if (shouldLockOn) {
        cb.checked = true;
        state.upgrades.add("engrave_inside_and_outside");
        row.classList.add("is-locked");
        cb.disabled = true;
      } else {
        row.classList.remove("is-locked");
        cb.disabled = false;
        cb.checked = false;
        state.upgrades.delete("engrave_inside_and_outside");
      }
    }

    function recalc() {
      state.variantKey = $variant.value || "";
      state.formatId = $format.value || "";
      state.qty = Number($qty.value || 0);

      state.shipMode = getShipMode();

      state.color = $color ? ($color.value || "") : "";
      state.engraving = $engr ? ($engr.value || "") : "";
      state.motif = $motif ? ($motif.value || "") : "";

      const prod = PR.products[state.matKey];
      const v = prod && prod.variants ? prod.variants[state.variantKey] : null;

      const isMetallBottle = (state.matKey === "metall" && state.variantKey === "flaschenoeffner");
      if (isMetallBottle) {
        const beid = (state.engraving === "beidseitig");
        lockBeidseitigUpgrade(beid);
      }

      let ok = true;
      let onRequest = false;
      let reasons = [];

      if (!state.matKey) { ok = false; reasons.push("Material fehlt."); }
      if (!state.variantKey) { ok = false; reasons.push("Ausführung fehlt."); }
      if (!state.formatId) { ok = false; reasons.push("Format fehlt."); }
      if (!state.qty || state.qty < 1) { ok = false; reasons.push("Stückzahl fehlt."); }

      if (v && v.minQty && state.qty < v.minQty) {
        ok = false;
        reasons.push(`Mindestmenge: ${v.minQty} Stück.`);
      }

      if (isMetallBottle) {
        if (!state.color) { ok = false; reasons.push("Farbe fehlt."); }
        if (!state.engraving) { ok = false; reasons.push("Gravur fehlt."); }
        if (!state.motif) { ok = false; reasons.push("Motiv fehlt."); }
      }

      let baseUnit = 0;

      if (ok && v) {
        if (state.matKey === "schiefer") {
          const fmt = (v.formats || []).find((f) => f.id === state.formatId);
          if (!fmt) { ok = false; reasons.push("Format ungültig."); }
          else baseUnit = Number(fmt.price || 0);
        }

        if (state.matKey === "metall" && Array.isArray(v.tiers)) {
          const t = tierUnit(v.tiers, state.qty);
          if (t.unit == null) onRequest = true;
          else baseUnit = Number(t.unit);
        }
      }

      let subtotal = 0;
      let upgradeOnce = 0;
      let upgradeUnit = 0;
      let upgradePerUnitLines = [];
      let upgradeOnceLines = [];

      if (ok && !onRequest) {
        subtotal += (baseUnit * state.qty);

        if (state.matKey === "schiefer" && prod && prod.upgrades) {
          for (const uKey of state.upgrades) {
            const u = prod.upgrades[uKey];
            if (!u) continue;
            upgradeOnce += Number(u.price || 0);
            upgradeOnceLines.push(`${u.label}: ${eur(Number(u.price || 0))}`);
          }
        }

        if (state.matKey === "metall" && v && v.upgrades) {
          const ups = v.upgrades;

          for (const uKey of state.upgrades) {
            const u = ups[uKey];
            if (!u) continue;

            if (u.type === "per_unit") {
              const uUnit = Number(u.unit || 0);
              upgradeUnit += uUnit;
              upgradePerUnitLines.push(`${u.label}: ${eur(uUnit)} / Stk`);
            }

            if (u.type === "one_time") {
              const once = Number(u.once || 0);
              upgradeOnce += once;
              upgradeOnceLines.push(`${u.label}: ${eur(once)} einmalig`);
            }

            if (u.type === "per_unit_tiered") {
              const t = tierUnit(u.tiers, state.qty);
              if (t.unit == null) onRequest = true;
              else {
                const uUnit = Number(t.unit);
                upgradeUnit += uUnit;
                upgradePerUnitLines.push(`${u.label}: ${eur(uUnit)} / Stk`);
              }
            }

            if (u.type === "setup_plus_per_unit_tiered") {
              const setup = Number(u.setupFee || 0);
              upgradeOnce += setup;
              upgradeOnceLines.push(`${u.label}: ${eur(setup)} Setup`);

              const t = tierUnit(u.tiers, state.qty);
              if (t.unit == null) onRequest = true;
              else {
                const uUnit = Number(t.unit);
                upgradeUnit += uUnit;
                upgradePerUnitLines.push(`${u.label}: ${eur(uUnit)} / Stk`);
              }
            }
          }

          if (!onRequest) subtotal += (upgradeUnit * state.qty);
        }

        subtotal += upgradeOnce;
      }

      const shipRes = shippingFor(subtotal, state.shipMode);
      if (!shipRes.ok) onRequest = true;

      const total = (!onRequest) ? (subtotal + (shipRes.price || 0)) : null;

      if ($shipHint) $shipHint.textContent = shipRes.note || "";

      const matLabel = prod ? (prod.label || state.matKey) : state.matKey;
      const varLabel = v ? (v.label || v.title || state.variantKey) : state.variantKey;
      const fmtLabel = (() => {
        if (!v) return "";
        const f = (v.formats || []).find((x) => x.id === state.formatId);
        return f ? (f.label || f.id) : state.formatId;
      })();

      const upgradesList = [];
      if (state.matKey === "schiefer" && prod && prod.upgrades) {
        state.upgrades.forEach((k) => {
          const u = prod.upgrades[k];
          if (u) upgradesList.push(u.label);
        });
      }
      if (state.matKey === "metall" && v && v.upgrades) {
        state.upgrades.forEach((k) => {
          const u = v.upgrades[k];
          if (u) upgradesList.push(u.label);
        });
      }

      const shipText = (state.shipMode === "dhl") ? "Versand (DHL)" : "Abholung";
      const noteText = clean($note.value);

      let summaryLines = [];
      if (!state.matKey) summaryLines.push("Bitte Material wählen.");
      else {
        summaryLines.push(`Material: <strong>${matLabel}</strong>`);
        if (state.variantKey) summaryLines.push(`Ausführung: <strong>${varLabel}</strong>`);
        if (state.formatId) summaryLines.push(`Format: <strong>${fmtLabel}</strong>`);

        if (isMetallBottle) {
          summaryLines.push(`Farbe: <strong>${state.color || "—"}</strong>`);
          summaryLines.push(`Gravur: <strong>${state.engraving || "—"}</strong>`);
          summaryLines.push(`Motiv: <strong>${state.motif || "—"}</strong>`);
        }

        if (state.qty) summaryLines.push(`Stückzahl: <strong>${state.qty}</strong>`);

        if (upgradesList.length) summaryLines.push(`Upgrades: <strong>${upgradesList.join(", ")}</strong>`);
        else summaryLines.push(`Upgrades: <strong>keine</strong>`);

        summaryLines.push(`Versand: <strong>${shipText}</strong>`);

        if (onRequest) {
          summaryLines.push(`<br><strong>Preis: Auf Anfrage</strong>`);
          if (shipRes && shipRes.note) summaryLines.push(`<span class="small muted">${shipRes.note}</span>`);
        } else if (ok) {
          if (state.matKey === "metall") {
            summaryLines.push(`<br>Basis: <strong>${eur(baseUnit)} / Stk</strong>`);
            if (upgradePerUnitLines.length) summaryLines.push(`Upgrades (pro Stück): <span class="small muted">${upgradePerUnitLines.join(" · ")}</span>`);
            if (upgradeOnceLines.length) summaryLines.push(`Upgrades (einmalig): <span class="small muted">${upgradeOnceLines.join(" · ")}</span>`);
          }
          if (state.matKey === "schiefer") {
            summaryLines.push(`<br>Basis: <strong>${eur(baseUnit)} / Stk</strong>`);
            if (upgradeOnceLines.length) summaryLines.push(`Upgrades: <span class="small muted">${upgradeOnceLines.join(" · ")}</span>`);
          }

          summaryLines.push(`Zwischensumme: <strong>${eur(subtotal)}</strong>`);
          summaryLines.push(`Versand: <strong>${shipRes.price === 0 ? "0,00 €" : eur(shipRes.price || 0)}</strong>`);
          summaryLines.push(`Gesamt: <strong>${eur(total)}</strong>`);
        }

        if (!ok && reasons.length) {
          summaryLines.push(`<br><strong>Fehlt:</strong> ${reasons.join(" ")}`);
        }
      }

      $sum.innerHTML = summaryLines.join("<br>");

      const canSend = ok && !onRequest;

      const msgLines = [
        "Hi Luderbein, ich möchte anfragen:",
        "",
        `- Material: ${matLabel}`,
        `- Ausführung: ${varLabel}`,
        `- Format: ${fmtLabel}`
      ];

      if (isMetallBottle) {
        msgLines.push(`- Farbe: ${state.color || ""}`);
        msgLines.push(`- Gravur: ${state.engraving || ""}`);
        msgLines.push(`- Motiv: ${state.motif || ""}`);
      }

      msgLines.push(`- Stückzahl: ${state.qty || ""}`);
      msgLines.push(`- Versand: ${shipText}`);

      if (upgradesList.length) msgLines.push(`- Upgrades: ${upgradesList.join(", ")}`);
      else msgLines.push(`- Upgrades: keine`);

      if (!onRequest && ok) {
        msgLines.push(`- Zwischensumme: ${eur(subtotal)}`);
        msgLines.push(`- Versand: ${shipRes.price === 0 ? "0,00 €" : eur(shipRes.price || 0)}`);
        msgLines.push(`- Gesamt: ${eur(total)}`);
      } else {
        msgLines.push("- Preis: Auf Anfrage");
      }

      if (noteText) msgLines.push(`- Notiz: ${noteText}`);

      const msg = msgLines.join("\n");
      $wa.href = `https://wa.me/${phoneWA}?text=${encodeURIComponent(msg)}`;

      const subject = `Anfrage – ${matLabel} – ${varLabel}`;
      const mailBody = msg.replace(/\n/g, "%0D%0A");
      $mail.href = `mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${mailBody}`;

      setDisabled($wa, !canSend);
      setDisabled($mail, !canSend);
    }

    // events
    $variant.addEventListener("change", onVariant);
    $format.addEventListener("change", onFormat);
    $qty.addEventListener("input", recalc);

    if ($color) $color.addEventListener("change", recalc);
    if ($engr)  $engr.addEventListener("change", recalc);
    if ($motif) $motif.addEventListener("change", recalc);

    if ($shipWrap) {
      const shipChips = els("[data-k-ship-chip]", $shipWrap);
      shipChips.forEach((lab) => {
        lab.addEventListener("click", () => {
          const inp = el("input", lab);
          if (!inp) return;
          setShipModeUI(inp.value);
          recalc();
        });
      });
    }

    // init
    buildMaterialChips();

    const firstChip = el(".chip", $matWrap);
    if (firstChip) firstChip.click();

    // ensure shipping UI state
    setShipModeUI(getShipMode());
    recalc();
  })();
</script>
</body>
</html>
