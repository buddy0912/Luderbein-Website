<script>
(function () {
  function guessTypeFromReferrer() {
    var r = (document.referrer || "").toLowerCase();
    if (!r) return "";
    if (r.includes("/leistungen/metall")) return "metall";
    if (r.includes("/leistungen/schiefer")) return "schiefer";
    if (r.includes("/leistungen/holz")) return "holz";
    return "";
  }

  function getRequestedType() {
    var params = new URLSearchParams(location.search);
    var t =
      (params.get("t") ||
       params.get("type") ||
       params.get("service") ||
       params.get("material") ||
       "").trim().toLowerCase();

    if (!t) t = guessTypeFromReferrer();
    return t;
  }

  function setDropdownTo(typeKeyword) {
    if (!typeKeyword) return false;

    // Suche das "wahrscheinlichste" Select (erst nach name/id, sonst erstes select)
    var selects = Array.from(document.querySelectorAll("select"));
    if (!selects.length) return false;

    // Kandidaten sortieren: erst die mit passenden name/id
    selects.sort(function(a,b){
      var aKey = ((a.id||"") + " " + (a.name||"")).toLowerCase();
      var bKey = ((b.id||"") + " " + (b.name||"")).toLowerCase();
      var aScore = (aKey.includes("typ") || aKey.includes("type") || aKey.includes("service") || aKey.includes("material")) ? 1 : 0;
      var bScore = (bKey.includes("typ") || bKey.includes("type") || bKey.includes("service") || bKey.includes("material")) ? 1 : 0;
      return bScore - aScore;
    });

    for (var s = 0; s < selects.length; s++) {
      var sel = selects[s];

      // Wenn User schon was anderes gew채hlt hat: nicht 체berschreiben
      // (nur 체berschreiben, wenn wirklich noch "erste Option" aktiv ist)
      if (sel.selectedIndex > 0) continue;

      var opts = Array.from(sel.options || []);
      for (var i = 0; i < opts.length; i++) {
        var opt = opts[i];
        var v = (opt.value || "").toLowerCase();
        var txt = (opt.textContent || "").toLowerCase();

        if (v.includes(typeKeyword) || txt.includes(typeKeyword)) {
          sel.value = opt.value;
          // Change-Event triggern, falls dein Kalkulator UI/Preise dar체ber aktualisiert
          sel.dispatchEvent(new Event("change", { bubbles: true }));
          return true;
        }
      }
    }
    return false;
  }

  document.addEventListener("DOMContentLoaded", function () {
    var t = getRequestedType();
    setDropdownTo(t);
  });
})();
</script>
