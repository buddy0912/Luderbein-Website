<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalkulator – Luderbein</title>
  <meta name="description" content="V1.4 – Schiefer-Kalkulator: auswählen, kalkulieren, dann per WhatsApp oder E-Mail anfragen." />
  <link rel="stylesheet" href="/assets/style.css?v=10" />
  <link rel="stylesheet" href="/assets/nav-dropdown.css?v=1" />

  <style>
    .calcbox{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:18px;
      padding:16px;
    }
    .calcgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:760px){.calcgrid{grid-template-columns:1fr}}
    label.smalllab{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }
    select,input[type="number"],textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .checkrow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .checkrow input{margin-top:3px}
    .checkrow .muted{font-size:12px;color:var(--muted);margin-top:2px}
    .subcard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:14px;
      margin-top:14px;
    }
    .total{font-size:18px;font-weight:800;letter-spacing:.2px}
    .warn{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,80,80,.25);
      background:rgba(255,80,80,.08);
      color:rgba(255,220,220,.95);
      font-size:13px;
      display:none;
    }
    .oknote{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      color:rgba(255,255,255,.85);
      font-size:13px;
      display:none;
    }
    .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .inline .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.86);
    }
    .radioStack{display:grid;gap:10px}
    .cartbox{margin-top:18px}
    .cartlist{display:grid;gap:12px;margin-top:12px}
    .cartitem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:10px;
    }
    .cartitem__row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .cartitem__price{font-weight:700}
    .cartitem__meta{color:var(--muted);font-size:13px}
    .cartbtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
    }
    .cartempty{color:var(--muted);font-size:13px}
    .cartactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  </style>
</head>

<body>
<header>
  <div class="wrap nav">
    <a class="brand" href="/">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <strong>Luderbein</strong><br>
        <span>Schwibbögen • Gravur • Sonderwünsche</span>
      </div>
    </a>
    <button class="navbtn" type="button" data-nav-toggle aria-expanded="false" aria-label="Menü öffnen">
      <span class="navicon"><span></span></span>
    </button>
    <nav class="menu" data-nav data-open="0" aria-label="Hauptmenü">
      <a href="/">Start</a>
      <details class="navdrop" data-navdrop>
        <summary class="navdrop__sum" aria-label="Leistungen öffnen">
          Leistungen <span class="navdrop__chev" aria-hidden="true">▾</span>
        </summary>
        <div class="navdrop__panel" role="menu" aria-label="Leistungen">
          <a href="/leistungen/schiefer/" role="menuitem">Schiefer</a>
          <a href="/leistungen/metall/" role="menuitem">Metall</a>
          <a href="/leistungen/holz/" role="menuitem">Holz</a>
          <a href="/leistungen/acryl-schilder/" role="menuitem">Acryl</a>
          <a href="/leistungen/#kommt" role="menuitem">Glas (kommt)</a>
          <a href="/kontakt/?p=Custom" role="menuitem">Custom</a>
          <div class="navdrop__sep" aria-hidden="true"></div>
          <a href="/tools/kalkulator/" role="menuitem">Kalkulator</a>
          <a href="/service/" role="menuitem">Downloads</a>
        </div>
      </details>
      <a href="/ueber/">Über</a>
      <a href="/kontakt/">Kontakt</a>
      <a href="/rechtliches/impressum.html">Impressum</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <span class="badge"><i></i> Tool</span>
    <h1>Kalkulator <small style="font-size:0.65em;opacity:0.7">(V1.4 – Schiefer)</small></h1>
    <p class="lead">
      Wähle Material + Variante + Format. Danach bekommst du eine fertige Nachricht,
      die du mir 1:1 per WhatsApp oder Mail schicken kannst.
    </p>
    <div class="notice">
      <strong style="color:var(--text)">Hinweis:</strong><br>
      Nur Schiefer ist aktuell aktiv. Metall/Holz/Acryl folgen – bitte bei Bedarf einfach anfragen.
    </div>
  </section>

  <section class="section">
    <div class="section-head">
      <h2>Konfiguration</h2>
      <p class="small muted">Fotogravur &amp; Gedenktafel (JL7) – Preise Stand 01/2026.</p>
    </div>

    <div class="calcbox">
      <div class="calcgrid">
        <div>
          <label class="smalllab" for="cat">Oberkategorie</label>
          <select id="cat">
            <option value="schiefer">Schiefer</option>
            <option value="metall">Metall (auf Anfrage)</option>
            <option value="holz">Holz (auf Anfrage)</option>
            <option value="acryl">Acryl (auf Anfrage)</option>
          </select>
        </div>
        <div>
          <label class="smalllab" for="variant">Ausführung</label>
          <select id="variant"></select>
        </div>
        <div>
          <label class="smalllab" for="format">Format</label>
          <select id="format"></select>
        </div>
        <div>
          <label class="smalllab" for="qty">Stückzahl</label>
          <input id="qty" type="number" min="1" max="50" value="1" />
        </div>
      </div>

      <div class="subcard" id="upgradesBox">
        <div class="inline" style="margin-bottom:10px">
          <div class="pill" id="inclPill">inkl. …</div>
          <div class="pill" id="notePill">Hinweis …</div>
        </div>

        <div class="grid">
          <div class="card" style="margin:0">
            <h3 style="margin-top:0">Upgrades</h3>
            <div class="checkrow">
              <input type="checkbox" id="widmung">
              <div><div><strong>Signatur / Widmung</strong> <span class="muted" id="p_widmung"></span></div></div>
            </div>
            <div style="height:10px"></div>
            <div class="radioStack" aria-label="Standfuß Auswahl">
              <div class="checkrow">
                <input type="radio" name="standfuss" id="sf_none" value="none" checked>
                <div><div><strong>Kein Standfuß</strong></div></div>
              </div>
              <div class="checkrow">
                <input type="radio" name="standfuss" id="sf_std" value="std">
                <div><div><strong>3D-Standfuß (schwarz)</strong> <span class="muted" id="p_sf_std"></span></div></div>
              </div>
            </div>
            <div style="height:10px"></div>
            <div class="checkrow">
              <input type="checkbox" id="wandhalter">
              <div><div><strong>3D-Wandhalterung</strong> <span class="muted" id="p_wandhalter"></span></div></div>
            </div>
            <div style="height:10px"></div>
            <div class="checkrow">
              <input type="checkbox" id="express">
              <div><div><strong>Express (3 Werktage)</strong> <span class="muted" id="p_express"></span></div></div>
            </div>
          </div>

          <div class="card" style="margin:0">
            <h3 style="margin-top:0">Versand / Abholung</h3>
            <div class="radioStack">
              <div class="checkrow">
                <input type="radio" name="ship" id="ship_pickup" value="pickup" checked>
                <div><div><strong>Abholung / Übergabe</strong></div></div>
              </div>
              <div class="checkrow">
                <input type="radio" name="ship" id="ship_send" value="send">
                <div><div><strong>Versand</strong> <span class="muted" id="p_ship"></span></div></div>
              </div>
            </div>
            <div class="hr" style="margin:14px 0"></div>
            <div class="total" id="total">Gesamt: —</div>
            <div class="warn" id="warn"></div>
            <div class="oknote" id="oknote"></div>
            <div class="section" style="margin-top:14px">
              <label class="smalllab" for="note">Notiz (optional)</label>
              <textarea id="note" placeholder="z. B. Koordinaten, Symbolwunsch, Deadline, besonderer Wunsch…"></textarea>
            </div>
            <div class="cta" style="margin-top:12px">
              <button class="btn" id="addToCart" type="button">Zur Sammelanfrage hinzufügen</button>
            </div>
            <div class="cta" style="margin-top:12px">
              <a class="btn primary" id="waLink" href="#" rel="noopener">WhatsApp</a>
              <a class="btn" id="mailLink" href="#">E-Mail</a>
            </div>
            <p class="small muted" style="margin-top:10px">Kalkulator gibt Richtung. Verbindlich wird’s erst nach meiner Bestätigung (Preis &amp; Motiv).</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section" aria-label="Sammelanfrage">
    <div class="section-head">
      <h2>Sammelanfrage</h2>
      <p class="small muted">Mehrere Positionen sammeln und als eine Anfrage senden.</p>
    </div>

    <div class="calcbox cartbox">
      <div class="cartempty" id="cartEmpty">Noch leer – füge Positionen aus der Konfiguration hinzu.</div>
      <div class="cartlist" id="cartList"></div>
      <div class="cartactions">
        <a class="btn primary" id="cartWa" href="#" rel="noopener">Mach mir ein Angebot</a>
        <a class="btn" id="cartMail" href="#">E-Mail</a>
        <button class="btn" id="cartClear" type="button">Sammelanfrage leeren</button>
      </div>
      <p class="small muted" style="margin-top:12px">Kalkulator gibt Richtung. Verbindlich wird’s erst nach meiner Bestätigung (Preis &amp; Motiv).</p>
    </div>
  </section>
</main>

<footer>
  <div class="wrap foot">
    <div class="small">© <span id="y"></span> Luderbein</div>
    <div class="small">
      <a href="/rechtliches/impressum.html">Impressum</a> ·
      <a href="/rechtliches/datenschutz.html">Datenschutz</a>
    </div>
  </div>
</footer>

<script src="/assets/site.js?v=10"></script>
<script src="/assets/nav-dropdown.js?v=1"></script>
<script src="/assets/pricing.js?v=1.4.0"></script>

<script>
document.getElementById('y').textContent = new Date().getFullYear();
console.log("pricing.js loaded:", window.LUDERBEIN_PRICING?.meta);
</script>

<script>
(function(){
  const P = window.LUDERBEIN_PRICING;
  if(!P || !P.products){console.warn("Pricing data missing");return;}

  const $cat=document.getElementById('cat'),
        $variant=document.getElementById('variant'),
        $format=document.getElementById('format'),
        $qty=document.getElementById('qty'),
        $widmung=document.getElementById('widmung'),
        $wandhalter=document.getElementById('wandhalter'),
        $express=document.getElementById('express'),
        $sfNone=document.getElementById('sf_none'),
        $sfStd=document.getElementById('sf_std'),
        $shipPickup=document.getElementById('ship_pickup'),
        $shipSend=document.getElementById('ship_send'),
        $total=document.getElementById('total'),
        $warn=document.getElementById('warn'),
        $oknote=document.getElementById('oknote'),
        $wa=document.getElementById('waLink'),
        $mail=document.getElementById('mailLink'),
        $note=document.getElementById('note'),
        $inclPill=document.getElementById('inclPill'),
        $notePill=document.getElementById('notePill'),
        $addToCart=document.getElementById('addToCart'),
        $cartList=document.getElementById('cartList'),
        $cartEmpty=document.getElementById('cartEmpty'),
        $cartWa=document.getElementById('cartWa'),
        $cartMail=document.getElementById('cartMail'),
        $cartClear=document.getElementById('cartClear');

  const CART_KEY = 'lb_sammelanfrage';

  function euro(n){return (Math.round(n*100)/100).toFixed(2).replace('.',',')+' €';}
  function getSchiefer(){return P.products.schiefer;}

  function fillVariant(){
    const cat=$cat.value;
    $variant.innerHTML='';
    if(!P.products[cat]||cat!=='schiefer'){
      const opt=document.createElement('option');
      opt.textContent="Nur auf Anfrage";
      $variant.appendChild(opt);
      $variant.disabled=true;$format.disabled=true;return;
    }
    $variant.disabled=false;
    const S=getSchiefer();
    Object.keys(S.variants).forEach(k=>{
      const v=S.variants[k],opt=document.createElement('option');
      opt.value=k;opt.textContent=v.label;
      $variant.appendChild(opt);
    });
  }

  function fillFormat(){
    const cat=$cat.value;if(cat!=='schiefer')return;
    const S=getSchiefer(),vKey=$variant.value,V=S.variants[vKey];
    $format.innerHTML='';
    V.formats.forEach(f=>{
      const opt=document.createElement('option');
      opt.value=f.id;opt.textContent=f.label+' – '+euro(f.price);
      $format.appendChild(opt);
    });
    $inclPill.textContent=S.includes||'inkl. …';
    $notePill.textContent=V.note||P.meta.note;
  }

  function getSelected(){
    const cat=$cat.value;if(cat!=='schiefer')return null;
    const S=getSchiefer(),V=S.variants[$variant.value],
          F=V.formats.find(x=>x.id===$format.value),
          qty=Math.max(1,parseInt($qty.value||'1',10)),
          U=S.upgrades,ups=[];
    if($widmung.checked)ups.push(U.widmung);
    if($sfStd.checked)ups.push(U.standfuss_std);
    if($wandhalter.checked)ups.push(U.wandhalter);
    if($express.checked)ups.push(U.express);
    const wantsShip=$shipSend.checked;
    return {S,V,F,qty,ups,wantsShip};
  }

  function calc(){
    const sel=getSelected();
    if(!sel||!sel.F){
      $total.textContent='Gesamt: —';
      $addToCart.disabled=true;
      return null;
    }
    const {S,V,F,qty,ups,wantsShip}=sel;
    const base=F.price*qty,up=ups.reduce((a,u)=>a+(u.price||0),0)*qty;
    let subtotal=base+up,ship=0,warn='',ok='';
    if(wantsShip&&P.shipping.enabled){
      const min=P.shipping.minOrderForShipping,free=P.shipping.freeShippingFrom;
      if(subtotal>=free){ok=`Versandkostenfrei ab ${euro(free)} erreicht.`;}
      else{ship=P.shipping.basePrice;ok=`Versand: ${euro(ship)}`;}
      if(subtotal<min){warn=`Mindestbestellwert für Versand: ${euro(min)}.`;}
    }
    const total=subtotal+ship;
    $total.textContent='Gesamt: '+euro(total);
    $warn.style.display=warn?'block':'none';$warn.textContent=warn;
    $oknote.style.display=ok?'block':'none';$oknote.textContent=ok;
    $addToCart.disabled=false;

    const lines=[
      "Hi Luderbein, ich möchte kalkulieren/anfragen:",
      `- Material: ${S.label}`,
      `- Ausführung: ${V.label}`,
      `- Format: ${F.label}`,
      `- Stückzahl: ${qty}`,
      `- Upgrades: ${ups.length?ups.map(u=>`${u.label} (${euro(u.price)})`).join(', '):'keine'}`,
      `- Versand: ${wantsShip?'ja':'nein'}`,
      `- Gesamt (V0): ${euro(total)} (${P.meta.note})`
    ];
    if($note.value.trim())lines.push(`- Notiz: ${$note.value.trim()}`);
    lines.push("Foto/Infos schicke ich gleich mit.");
    const msg=lines.join('\n');
    $wa.href='https://wa.me/491725925858?text='+encodeURIComponent(msg);
    const subj=`Kalkulation ${S.label} – ${V.label}`;
    $mail.href='mailto:luderbein_gravur@icloud.com?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(msg+'\n\nDanke!');

    return {
      product: S.label,
      variant: V.label,
      format: F.label,
      qty,
      upgrades: ups.map(u => u.label),
      ship: wantsShip ? 'ja' : 'nein',
      estimate: total,
      note: $note.value.trim()
    };
  }

  function bindPrices(){
    const U=getSchiefer().upgrades;
    document.getElementById('p_widmung').textContent = `+ ${euro(U.widmung.price)}`;
    document.getElementById('p_sf_std').textContent = `+ ${euro(U.standfuss_std.price)}`;
    document.getElementById('p_wandhalter').textContent = `+ ${euro(U.wandhalter.price)}`;
    document.getElementById('p_express').textContent = `+ ${euro(U.express.price)}`;
    document.getElementById('p_ship').textContent = `+ ${euro(P.shipping.basePrice)}`;
  }

  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    }catch(e){
      return [];
    }
  }

  function saveCart(items){
    try{
      localStorage.setItem(CART_KEY, JSON.stringify(items));
    }catch(e){
      // ignore
    }
  }

  function renderCart(){
    const items = loadCart();
    $cartList.innerHTML='';
    $cartEmpty.style.display = items.length ? 'none' : 'block';

    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'cartitem';
      el.dataset.id = item.id;

      const title = [item.product, item.variant, item.format].filter(Boolean).join(' • ');
      const upgrades = item.upgrades?.length ? item.upgrades.join(', ') : 'keine';

      el.innerHTML = `
        <div><strong>${title}</strong></div>
        <div class="cartitem__meta">Upgrades: ${upgrades} · Versand: ${item.ship}</div>
        ${item.note ? `<div class="cartitem__meta">Notiz: ${item.note}</div>` : ''}
        <div class="cartitem__row">
          <label class="smalllab" style="margin:0">
            Menge
            <input type="number" min="1" value="${item.qty}" data-cart-qty>
          </label>
          <div class="cartitem__price">≈ ${euro(item.estimate)}</div>
          <button class="cartbtn" type="button" data-cart-remove>Entfernen</button>
        </div>
      `;
      $cartList.appendChild(el);
    });

    updateCartLinks(items);
  }

  function updateCartLinks(items){
    if(!items.length){
      $cartWa.href = '#';
      $cartMail.href = '#';
      return;
    }

    const lines = [
      'Hi Luderbein, hier ist meine Sammelanfrage (unverbindlich):',
      ''
    ];

    items.forEach((item, idx) => {
      const head = [item.product, item.variant, item.format].filter(Boolean).join(' • ');
      lines.push(`${idx + 1}) ${head}`);
      lines.push(`- Menge: ${item.qty}`);
      lines.push(`- Preisrichtung: ${euro(item.estimate)}`);
      if(item.upgrades?.length){
        lines.push(`- Upgrades: ${item.upgrades.join(', ')}`);
      }
      if(item.note){
        lines.push(`- Notiz: ${item.note}`);
      }
      lines.push('');
    });

    lines.push('Kalkulator gibt Richtung. Verbindlich wird’s erst nach deiner Bestätigung (Preis & Motiv).');
    lines.push('Foto/Infos schicke ich gleich mit.');

    const msg = lines.join('\n');
    $cartWa.href = 'https://wa.me/491725925858?text=' + encodeURIComponent(msg);
    $cartMail.href = 'mailto:luderbein_gravur@icloud.com?subject=' + encodeURIComponent('Sammelanfrage – Luderbein') + '&body=' + encodeURIComponent(msg + '\n\nDanke!');
  }

  function addToCart(){
    const item = calc();
    if(!item) return;
    const items = loadCart();
    items.push({
      id: `${Date.now()}-${Math.random().toString(16).slice(2,7)}`,
      ...item
    });
    saveCart(items);
    renderCart();
  }

  function init(){
    bindPrices();
    fillVariant();
    fillFormat();
    calc();
    renderCart();
  }

  $cat.addEventListener('change', () => {fillVariant();fillFormat();calc();});
  $variant.addEventListener('change', () => {fillFormat();calc();});
  $format.addEventListener('change', calc);
  $qty.addEventListener('input', calc);
  [$widmung,$wandhalter,$express,$sfNone,$sfStd,$shipPickup,$shipSend,$note].forEach(el => {
    el.addEventListener('change', calc);
    if (el === $note) el.addEventListener('input', calc);
  });

  $addToCart.addEventListener('click', addToCart);

  $cartList.addEventListener('input', (e) => {
    const target = e.target;
    if(!target.matches('[data-cart-qty]')) return;
    const itemEl = target.closest('.cartitem');
    if(!itemEl) return;
    const items = loadCart();
    const item = items.find(i => i.id === itemEl.dataset.id);
    if(!item) return;
    const newQty = Math.max(1, parseInt(target.value || '1', 10));
    const perUnit = item.estimate / item.qty;
    item.qty = newQty;
    item.estimate = Math.round(perUnit * newQty * 100) / 100;
    saveCart(items);
    renderCart();
  });

  $cartList.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-cart-remove]');
    if(!btn) return;
    const itemEl = btn.closest('.cartitem');
    if(!itemEl) return;
    const items = loadCart().filter(i => i.id !== itemEl.dataset.id);
    saveCart(items);
    renderCart();
  });

  $cartClear.addEventListener('click', () => {
    saveCart([]);
    renderCart();
  });

  init();
})();
</script>
